<!DOCTYPE html>

<html>
    <head>
        <title>Tatsu WebGL Demo</title>
        <!-- TODO: Minify tatsu.js and associated scripts. -->
        <script src="/lib/jquery-1.7.2.js"></script>
        <script src="/lib/glMatrix-0.9.5.min.js"></script>
        <script src="/lib/webgl-debug.js"></script>
        <script src="/src/Tatsu.js"></script>
        <script src="/src/Graphics/Types.js"></script>
        <script src="/src/Graphics/Renderer.js"></script>
        <script src="/src/Graphics/Material.js"></script>
        <script src="/src/Graphics/Model.js"></script>
        
        <script type="text/javascript">
            var tatsu, material, redMaterial, modelTri, modelSquare, modelTeapot,
                matModelView = mat4.identity(mat4.create()),
                matProj = mat4.perspective(45, 800/600, 0.1, 100.0, mat4.create()), 
                time = 0, deltaTime = 1 / 60;

            function draw() {
                var zScale = 0;
                tatsu.clear();

                // initial state
                time += deltaTime * 2;

                zScale = (Math.sin(time) + 2) * -7;

                // Bind materials and uniforms
                material.bindScope(function () {
                    mat4.identity(matModelView);
                    mat4.translate(matModelView, [-1.5, 0.0, zScale]);

                    this.bindUniform('matModelView', matModelView);
                    this.bindUniform('matProj', matProj);
                    this.bindUniform('color', [0, 1, 0]);

                    // Bind model and attributes
                    // Draw triangle
                    modelTri.bindScope(material, function () {
                        this.draw();
                    });

                    // update model-view
                    mat4.translate(matModelView, [3.0, 0.0, 0.0]);
                    this.bindUniform('matModelView', matModelView);
                    this.bindUniform('color', [0, 0, 1]);

                    // TODO: draw square
                    modelSquare.bindScope(material, function () {
                        this.draw();
                    });

                    mat4.translate(matModelView, [-6.0, 0.0, 0.0]);
                    this.bindUniform('matModelView', matModelView);
                    this.bindUniform('color', [1, 0, 0]);

                    // modelTeapot.bindScope(material, function () {
                    //     this.draw();
                    // });
                });
                

                // update model-view
                // mat4.translate(matModelView, [3.0, 0.0, 0.0]);
                // material.bindUniform('matModelView', matModelView);
                // material.bindUniform('color', [0, 0, 1]);
                // material.bindUniform('alpha', 0.5);

                // TODO: draw square
                // modelSquare.bind(material);
                // modelSquare.draw();

                // modelTeapot.bind(material);
                // modelTeapot.draw();

                // second material
                // mat4.translate(matModelView, [3.0, 0.0, 0.0]);
                // redMaterial.bind();
                // redMaterial.bindUniform('matModelView', matModelView);
                // redMaterial.bindUniform('matProj', matProj);
                // modelSquare.draw();
            }

            function doFrame() {
                requestAnimationFrame(doFrame);
                draw();
            }

            function tatsuLoad() {
                tatsu = new Tatsu.Renderer({
                    element: 'tatsu-canvas',
                    clearColor: [0.392156862745098, 0.5843137254901961, 0.9294117647058824, 1.0]
                });
                material = new Tatsu.Material(tatsu, {
                    fragmentUrl: '/demo/sandbox/sandbox.fs',
                    vertexUrl: '/demo/sandbox/sandbox.vs'
                });
                redMaterial = new Tatsu.Material(tatsu, {
                    fragmentUrl: '/demo/sandbox/sandbox-red.fs',
                    vertexUrl: '/demo/sandbox/sandbox.vs'
                });
                modelTri = new Tatsu.Model(tatsu, {
                    streams: {
                        position: {
                            type: 'float',
                            stride: 3,
                            data: [
                                 0.0,  1.0,  0.0,
                                -1.0, -1.0,  0.0,
                                 1.0, -1.0,  0.0
                            ]
                        }
                    },
                    faces: {
                        type: 'uint16',
                        data: [0, 1, 2]
                    }
                });
                modelSquare = new Tatsu.Model(tatsu, {
                    streams: {
                        position: {
                            type: 'float',
                            stride: 3,
                            data: [
                                 1.0,  1.0,  0.0,
                                -1.0,  1.0,  0.0,
                                 1.0, -1.0,  0.0,
                                -1.0, -1.0,  0.0
                            ]
                        }
                    },
                    faces: {
                        type: 'uint16',
                        data: [0, 1, 2, 1, 3, 2]
                    }
                });
                modelTeapot = new Tatsu.Model(tatsu, {
                    modelUrl: '/demo/sandbox/teapot.json'
                })


                doFrame();
            }

            $(function() {
                var jqCanvas = $('#tatsu-canvas');

                matProj = mat4.perspective(45, jqCanvas.width()/jqCanvas.height(), 0.1, 100.0, mat4.create());
            })
        </script>
    </head>
    <body onload="tatsuLoad();">
        <canvas id="tatsu-canvas" style="border: none;" width="1440" height="672"></canvas>
    </body>
</html>